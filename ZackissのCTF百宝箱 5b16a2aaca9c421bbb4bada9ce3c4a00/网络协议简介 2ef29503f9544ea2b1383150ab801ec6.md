# 网络协议简介

### 网络协议

<aside>
💡 计算机网络组成：应用层 <- 传输层 <- 网络层 <- 数据链路层 <- 物理层

</aside>

1. TCP与UDP协议
    - 服务于传输层，目的在程序之间传输数据的协议
        
        <aside>
        💡 信道不可靠时，依靠三次握手，依然可以建立可靠连接的协议
        
        </aside>
        
    - TCP为基于连接的通信，即时反馈（类似于打电话）
    - UDP为非连接的通信，非即时反馈（类似于写信）
    - TCP的通信过程
        1. 三次握手
            
            <aside>
            💡 如果只有两次握手，有可能重复接收SYN包，造成无限期等待
            
            </aside>
            
            1. 客户端向服务端发起连接请求，发送**SYN**包
            2. 服务端同意连接，向客户端回复**SYN+ACK**包
            3. 客户端收到**SYN+ACK**包，向服务端回复**ACK**包
            4. 连接建立
        2. 传输数据
            
            <aside>
            💡 为了防止丢包和乱序，采用了拆分数据为多个有序的包发送的发送方式
            
            </aside>
            
            1. 将数据存入发送缓冲区，分块存储，并为所有块标记索引（**序列号**）
            2. 发送端送出发送报文（可以发送多次）
                1. 发送报文为：**序列号**+这几个包的**长度**+包内的**数据内容**，三部分组成
            3. 接收端回复确认报文（如果发送多次，只需回复一次）
                1. 确认报文为：**ACK**包，组成为发送报文的前两部分（**序列号**+**长度**）
                2. 确认报文的内容将作为下一包数据的起始**序列号**
            4. 检测是否丢包，要求丢失重传
            5. 接收端根据**序列号**和**长度**，将**数据内容**重构为原有的数据
        3. 四次挥手
            
            <aside>
            💡 在关闭连接时，进行四次挥手
            
            </aside>
            
            <aside>
            💡 超时等待为了确保服务端已收到ACK包，未收到则重新开始三、四次挥手
            
            </aside>
            
            1. 客户端向服务端发起**FIN**包，请求关闭连接（客户端进入**终止等待-1**状态）
            2. 客户端向服务端发送**ACK**包，同意关闭（服务端进入**关闭等待**状态，客户端进入**终止等待-2**状态）
            3. 服务端发送所有未发完的数据，结束后，向客户端发送**FIN**包（服务端进入**最后确认**状态）
            4. 客户端向服务端发送**ACK**包，最后确认关闭（服务端收到立即关闭，客户端进入**超时等待**状态）
            5. 客户端等待过后，立即关闭
    - UDP的通信过程
        1. 封装数据包，发送到接收端（无状态)
        2. 用于隧道网络（VPN，VXLAN）
2. HTTP协议
    - 服务于应用层，用于传输超文本内容的协议（基于TCP）
    - HTTP的通信过程
        1. 经由DNS协议将域名变为IP地址
        2. 浏览器向服务器发送GET报文（请求头）
            1. **GET** **/**target.html **HTTP/1.1**
            2. **Host:** 1.2.3.4:8080（为服务器地址）
            3. **Connection:** keep-alive （为请求的连接方式，长连接）
            4. **Accept:** text/html（为浏览器可接受格式）
            5. **User-Agent:** Mozilla/5.0（为浏览器本身相关）
            6. **Accept-Encoding:** gzip（为浏览器可接受编码）
            7. **Accept-Language:** zh-CN,zh;q=0.8（为浏览器可接受语言类型）
        3. 服务器向浏览器回复（响应头）
            1. **HTTP/1.1 200 OK**（回复200，404等识别码，判断是否请求成功，找没找到要求的文件）
            2. **Cache-Control:** private（缓存为公有还是私有）
            3. **Content-Encoding:** gzip（传回信息的编码）
            4. **Date:** Fri, 20 Oct 2017 00:59:11 GMT（服务器时间）
            5. **Content-Type:** text/html（传回信息的格式）
            6. **Server:** Apache/1.1（服务器框架及版本，Nginx等）
3. 常见攻击流程
    - 通过浏览器访问对应的靶场http服务：`http://ip:port`
    - 使用探测工具寻找http目录下文件：
        
        <aside>
        💡 普通端口小于1024，大于1024的端口很可能是用户自己支配的特殊端口
        
        </aside>
        
        ```bash
        dirb [http://ip:port/]
        ```
        
        - 注意事项
            - 尽量将dirb出现的每一个目录页面都用浏览器访问一遍
            - 要尤其注意页面展示内容，尤其是其中的联系人信息（可能是ssh用户名）
            - 若开放了SSH服务，要注意是否可以找到id_rsa私钥文件
            - 注意robot.txt中隐藏的目录，可能是关键目录